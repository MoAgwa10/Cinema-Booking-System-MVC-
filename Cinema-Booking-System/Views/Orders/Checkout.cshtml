@model PaymentRequest

@{
    ViewData["Title"] = "Secure Checkout";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        Secure Payment
                    </h4>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="ProcessPayment" method="post" id="paymentForm">
                        <div class="row">
                            <!-- Payment Information -->
                            <div class="col-md-12">
                                <h5 class="mb-3">
                                    <i class="bi bi-credit-card me-2"></i>
                                    Payment Information
                                </h5>
                                
                                <div class="form-group mb-3">
                                    <label asp-for="CardNumber" class="form-label">
                                        <i class="bi bi-credit-card me-1"></i>
                                        Card Number
                                    </label>
                                    <div class="input-group">
                                        <input asp-for="CardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" id="cardNumber" />
                                        <span class="input-group-text" id="cardTypeIcon">
                                            <i class="bi bi-credit-card"></i>
                                        </span>
                                    </div>
                                    <span asp-validation-for="CardNumber" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        Test cards: End with 0 (declined), 1 (insufficient funds), 2 (expired), 3 (invalid CVV), others (success)
                                    </small>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="CardholderName" class="form-label">
                                        <i class="bi bi-person me-1"></i>
                                        Cardholder Name
                                    </label>
                                    <input asp-for="CardholderName" class="form-control" placeholder="John Doe" />
                                    <span asp-validation-for="CardholderName" class="text-danger"></span>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="ExpiryMonth" class="form-label">Month</label>
                                            <select asp-for="ExpiryMonth" class="form-control">
                                                <option value="">MM</option>
                                                @for (int i = 1; i <= 12; i++)
                                                {
                                                    <option value="@i">@i.ToString("00")</option>
                                                }
                                            </select>
                                            <span asp-validation-for="ExpiryMonth" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="ExpiryYear" class="form-label">Year</label>
                                            <select asp-for="ExpiryYear" class="form-control">
                                                <option value="">YYYY</option>
                                                @for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 10; i++)
                                                {
                                                    <option value="@i">@i</option>
                                                }
                                            </select>
                                            <span asp-validation-for="ExpiryYear" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="CVV" class="form-label">
                                                <i class="bi bi-shield-lock me-1"></i>
                                                CVV
                                            </label>
                                            <input asp-for="CVV" class="form-control" placeholder="123" maxlength="4" />
                                            <span asp-validation-for="CVV" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Billing Address -->
                            <div class="col-md-12 mt-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    Billing Address
                                </h5>
                                
                                <div class="form-group mb-3">
                                    <label asp-for="BillingAddress" class="form-label">Address</label>
                                    <input asp-for="BillingAddress" class="form-control" placeholder="123 Main Street" />
                                    <span asp-validation-for="BillingAddress" class="text-danger"></span>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="City" class="form-label">City</label>
                                            <input asp-for="City" class="form-control" placeholder="New York" />
                                            <span asp-validation-for="City" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label asp-for="PostalCode" class="form-label">Postal Code</label>
                                            <input asp-for="PostalCode" class="form-control" placeholder="12345" />
                                            <span asp-validation-for="PostalCode" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="Country" class="form-label">Country</label>
                                    <select asp-for="Country" class="form-control">
                                        <option value="United States">United States</option>
                                        <option value="Canada">Canada</option>
                                        <option value="United Kingdom">United Kingdom</option>
                                        <option value="Australia">Australia</option>
                                    </select>
                                    <span asp-validation-for="Country" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a asp-action="ShoppingCart" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Back to Cart
                            </a>
                            <button type="submit" class="btn btn-success btn-lg" id="payButton">
                                <i class="bi bi-lock-fill me-2"></i>
                                Pay @Model.Amount.ToString("C")
                                <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>
                        Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <span>@Model.Amount.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tax:</span>
                        <span>$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span>@Model.Amount.ToString("C")</span>
                    </div>
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-check text-success me-2"></i>
                            <small class="text-muted">
                                Your payment is secured with 256-bit SSL encryption
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Card number formatting and validation
            $('#cardNumber').on('input', function() {
                let value = $(this).val().replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                $(this).val(formattedValue);
                
                // Detect card type
                detectCardType(value);
            });

            // CVV input restriction
            $('#CVV').on('input', function() {
                $(this).val($(this).val().replace(/[^0-9]/g, ''));
            });

            // Form submission with loading state
            $('#paymentForm').on('submit', function() {
                $('#payButton').prop('disabled', true);
                $('#loadingSpinner').removeClass('d-none');
                $('#payButton').html('<i class="bi bi-lock-fill me-2"></i>Processing Payment...<span class="spinner-border spinner-border-sm ms-2"></span>');
            });

            function detectCardType(cardNumber) {
                const cardTypeIcon = $('#cardTypeIcon i');
                
                if (cardNumber.match(/^4/)) {
                    cardTypeIcon.removeClass().addClass('bi bi-credit-card text-primary');
                    cardTypeIcon.attr('title', 'Visa');
                } else if (cardNumber.match(/^5[1-5]/)) {
                    cardTypeIcon.removeClass().addClass('bi bi-credit-card text-warning');
                    cardTypeIcon.attr('title', 'MasterCard');
                } else if (cardNumber.match(/^3[47]/)) {
                    cardTypeIcon.removeClass().addClass('bi bi-credit-card text-info');
                    cardTypeIcon.attr('title', 'American Express');
                } else if (cardNumber.match(/^6/)) {
                    cardTypeIcon.removeClass().addClass('bi bi-credit-card text-success');
                    cardTypeIcon.attr('title', 'Discover');
                } else {
                    cardTypeIcon.removeClass().addClass('bi bi-credit-card');
                    cardTypeIcon.attr('title', 'Credit Card');
                }
            }
        });
    </script>
}
